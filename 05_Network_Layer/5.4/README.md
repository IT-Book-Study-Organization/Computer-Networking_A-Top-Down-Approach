# 5.4 ISP 간 라우팅: BGP 요약

- AS(Autonomous System) 내부에서는 **OSPF 같은 내부 라우팅 프로토콜**이 경로를 결정하지만, 여러 AS를 거쳐야 하는 경우 **인터-AS 라우팅 프로토콜**이 필요함.  
- 인터넷에서는 **모든 AS가 동일한 인터-AS 라우팅 프로토콜, 즉 BGP(Border Gateway Protocol)를 실행**해야 함.  
- **BGP는 수천 개의 ISP를 연결하는 인터넷의 핵심 프로토콜**로, 거리 벡터(distance-vector) 라우팅과 유사하지만 **비집중적(decentralized)이고 비동기적(asynchronous)인 방식**으로 작동함.  
- BGP는 복잡하지만, 인터넷 구조를 이해하는 데 필수적인 프로토콜임.

## 5.4.1 BGP의 역할

인터넷에서 AS(Autonomous System) 간 라우팅을 담당하는 프로토콜은 BGP(Border Gateway Protocol)이다. 내부 라우팅은 OSPF 같은 프로토콜이 처리하지만, AS 외부 목적지는 BGP가 경로를 결정한다. BGP는 CIDR(Classless Inter-Domain Routing) 방식으로 서브넷 단위로 라우팅(즉, 개별 IP 주소가 아니라 프리픽스([Prefix](https://jdcyber.tistory.com/51)) 단위로 경로를 설정하고 관리)하며, 두 가지 핵심 역할을 수행한다.

1. **프리픽스 도달 가능성 정보 획득**
   - 특정 네트워크(프리픽스)의 존재를 다른 AS에 알리고 학습하게 함.
2. **최적 경로 결정**
   - 네트워크 정책과 도달 가능성 정보를 기반으로 최적의 경로 선택.

BGP가 없다면, AS 간 연결이 불가능하여 인터넷이 정상적으로 동작할 수 없다.

## 5.4.2 BGP 경로 정보 광고

### BGP 경로 광고(Advertising) 개념

BGP는 AS 간의 프리픽스 도달 가능성 정보를 공유하여, 인터넷의 모든 라우터가 특정 네트워크를 인식할 수 있도록 한다.

![Screenshot 2025-02-05 at 2 47 45 AM](https://github.com/user-attachments/assets/39748087-4207-43f4-a00c-ffd65216ea0f)

#### 경로 광고 예시
1. AS3가 AS2에 **"AS3 x"** 메시지를 보냄.
2. AS2가 AS1에 **"AS2 AS3 x"** 메시지를 전달.
3. AS1은 프리픽스 x로 가는 경로를 학습.

이를 통해 AS1과 AS2는 프리픽스 x의 존재뿐만 아니라 **x로 가는 경로(AS 경로 정보)**까지 학습할 수 있다.

### BGP 메시지 전달 방식

BGP는 반영구적인 TCP 연결(포트 179)을 유지하며, **eBGP(External BGP)와 iBGP(Internal BGP)**를 통해 정보를 전달한다.

![Screenshot 2025-02-05 at 2 47 54 AM](https://github.com/user-attachments/assets/c00475ad-3845-49bd-bfbf-5fae29143648)

- **eBGP**: AS 간 BGP 연결 (예: AS1의 라우터 1c ↔ AS2의 라우터 2a)
- **iBGP**: AS 내부 BGP 연결 (예: AS2 내부의 모든 라우터 간 연결)

#### BGP 경로 광고 과정
1. AS3 → AS2 (eBGP 메시지): "AS3 x"
2. AS2 내부 (iBGP 메시지): "AS3 x" 확산
3. AS2 → AS1 (eBGP 메시지): "AS2 AS3 x"
4. AS1 내부 (iBGP 메시지): "AS2 AS3 x" 확산

이 과정을 통해 모든 라우터가 프리픽스 x와 최적 경로를 학습한다.

## 5.4.3 최적 경로 결정

### BGP의 핵심 속성

BGP는 프리픽스를 광고할 때 여러 속성을 포함하여 경로 정보를 제공한다.

1. **AS-PATH**: 지나온 AS 목록을 포함하여 루프를 방지함. (이 번호들의 갯수가 작을 경우 짧은 경로로 판단함, 이 번호들 중 자신의 AS 번호가 있으면 해당 정보를 무시함)
2. **NEXT-HOP**: AS-PATH에서 첫 번째 AS의 라우터 IP 주소를 지정. (BGP 정보를 전송하는 라우터의 IP 주소로써, 목적지까지 가는 경로에서 반드시 자신을 거쳐야만 한다고 알리는 Next Hop 라우터의 주소를 말함)

### 핫 포테이토 라우팅 (Hot Potato Routing)

- AS 내부 비용을 최소화하는 경로를 선택하는 방식.
- 예: AS1의 1b 라우터가 프리픽스 x까지 가는 두 개의 경로를 학습할 경우,
  - "AS2 AS3 x" (2 홉)
  - "AS3 x" (3 홉)
  - 홉 수가 적은 "AS2 AS3 x"를 선택.

![Screenshot 2025-02-05 at 2 48 01 AM](https://github.com/user-attachments/assets/b6da896a-3b94-4ea4-bbcc-a97f32e8c6b1)

### BGP의 경로 선택 알고리즘

1. **로컬 프리퍼런스(Local Preference)**: 네트워크 정책에 따라 우선 순위가 높은 경로 선택.
2. **AS-PATH 길이 확인**: AS를 가장 적게 거치는 경로를 선호.
3. **핫 포테이토 라우팅 적용**: AS-PATH 길이가 동일하면, 인트라-AS 비용이 가장 낮은 경로 선택.
4. **BGP 식별자(BGP Identifier) 비교**: 모든 조건이 동일하면 라우터 ID 기준으로 경로 결정.


---

## 5.4.4 IP-애니캐스트
BGP는 인터넷의 AS간 라우팅 프로토콜일 뿐만 아니라, DNS에서 흔히 사용되는 IP-애니캐스트 서비스를 구현하는 데에도 사용됨

IP-애니캐스트가 필요한 이유
   1. 같은 콘텐츠를 지리적으로 분산된 여러 다른 위치의 서버들에 복제하기 위해
   2. 각 사용자가 가장 가까운 서버에서 콘텐츠에 접근하도록 하기 위해

CDN이 어떻게 IP-애니캐스트를 사용하는가
![image](https://github.com/user-attachments/assets/714d4bc0-9031-4c26-8faa-86689ecbd3e6)

최선의 경로(예: AS-홉 수로 결정되는 가장 가까운)<BR>
광고 단계 이후, CDN은 콘텐츠 배포라는 주요 작업을 수행할 수 있다<BR>
> 클라이언트가 비디오를 요청<BR>
> CDN은 클라이언트가 어디에 있든 분산된 서버들이 사용하는 공통 IP주소를 반환함<BR>
> 클라이언트가 해당 IP주소로 요청을 보내면,<BR>
> 인터넷 라우터들은 BGP 경로 알고리즘에 의해 가장 가까운 서버로 요청 패킷을 전달함<BR>

위 예시를 통해서 IP-애니캐스트를 어떻게 사용하는지 잘 알 수 있었음. 그렇지만 실제로 CDN은 일반적으로 IP-애니캐스트를 사용하지 않음. <BR>
=> IP-애니캐스트는 DNS쿼리를 가장 가까운 루트 DNS서버로 안내하기 위해 사용됨.<BR>
> 현재 루트 DNS서버들을 위한 13개의 IP주소가 있음<BR>
> DNS쿼리가 이 13개의 IP주소 중 하나로 전송되면,
> **IP 애니캐스트는 해당 주소를 담당하는 DNS 루트 서버들 중 가장 가까운 곳으로 쿼리를 라우팅하는 데 사용됨.**

---

## 5.4.5 라우팅 정책

AS 라우팅 정책은 최단 AS경로나 핫 포테이토 라우팅과 같은 다른 모든 고려사항들보다 우선할 수 있다. 로컬 AS의 정책에 의해 값이 고정되는 로컬-선호도 속성에 따라 경로가 먼저 선택된다. 

라우팅 정책의 기본 개념들을 살펴보자. <BR>
![image](https://github.com/user-attachments/assets/708ed353-65a2-41bc-8d06-69a7ef698a5c)

그림 5.13은 A, B, C, W, X, Y라는 여섯 개의 상호 연결된 자율 시스템을 보여준다. 이때  A, B, C, W, X, Y가 라우터가 아닌 AS라는 점을 주목하는 것이 중요!<BR>
ISP 접속 네트워크로 들어가는 모든 트래픽은 해당 네트워크를 목적지로 해야 하며, ISP 접속 네트워크를 떠나는 모든 트래픽은 해당 네트워크에서 발생했어야 함.<BR>

X는 지금 두 개의 네트워크에 연결되어있기에 멀티홈 접속 ISP임. **하지만 W와 Y처럼, X자체도 X를 떠나거나 들어오는 모든 트래픽의 출발지/목적지여야 함.** <BR>
X가 B와 C사이의 트래픽을 전달하는 것을 어떻게 막냐<BR>
**-> BGP 경로가 광고되는 방식을 제어하면 가능. B → X → C 같은 우회 경로 차단**<BR>
(X는 자신 외에는 다른 목적지로 가는 경로가 없다고 B와 C에게 광고하면 접속 ISP 네트워크로 기능함. <BR>

이제 제공자 네트워크 AS B에 초점을 맞춰보자. <BR>
B가 AW경로를 A가 가지고 있다는 것으 안다고 가정함. 그러면 B는 AW경로를 라우팅 정보 베이스에 저장. 그러면 B는 자신의 고객인 X에게 BAW경로를 광고하기를 원함. X는 B를 통해 W로 라우팅할 수 있다는 것을 알 수 있게됨.
하지만 B가 BAW경로를 C에게도 광고해야하나? 그렇게 되면 B가 A와 C사이의 중계트래픽을 처리하는 부담을 져야하므로 그럴 필요가 없음. 

> ### 정리
> X의 입장:
- X는 자신을 통과하는 트래픽만 처리해야 함
- 다른 네트워크의 통과 트래픽은 처리하지 않음
> B의 입장:
- 자신의 고객(X)에게는 모든 경로 정보 제공
- 다른 백본 제공자(C)에게는 선택적으로 정보 제공

   현재 백본 ISP들이 어떻게 라우팅해야 하는지 규정하는 공식 표준은 없으나, 상업 ISP들이 따르는 경험적 규칙은 **ISP의 백본 네트워크를 통과하는 모든 트래픽은 출발지나 목적지 중 하나가 해당 ISP의 고객 네트워크여야 한다는 것.**

---

## 5.4.6 조각들을 맞추기: 인터넷 존재감 얻기
IP 주소 지정, DNS, BGP를 포함하여 지금까지 살펴본 많은 프로토콜과 개념들을 통합하자

가정: 여러 서버들을 가진 작은 회사를 만들었다. 여기엔 회사 제품을 설명하는 공개 웹 서버, 직원들 메일 서버, DNS서버가 있다. 전세계 사람들이 웹사이트를 방문하기를 원함. 
   1. 인터넷 연결을 위한 물리적 연결 및 IP 주소 확보
      지역 ISP와 계약하고 회사는 게이트웨이 라우터를 통해 지역ISP의 라우터와 연결될 것. ISP로부터 IP 주소 범위 할당 받음. 할당받은 IP를 각 서버에 분배함(웹, 메일, DNS 서버 등)
   2. 도메인 이름 및 DNS 설정
      인터넷 등록기관과 계약하여 도메인 이름을 획득하고, DNS 서버 IP 주소를 등록기관에 제공함. 등록기관이 .com 최상위 도메인 서버에 DNS 정보를 등록함. 사용자가 도메인 이름을 검색하면 DNS시스템을 통해 IP주소를 매핑함.
   3. 글로벌 라우팅 설정(BGP 활용)
      지역 ISP가 회사의 IP프리픽스를 BGP로 광고하고, 다른 ISP들이 이 정보를 전파함.
      결과적으로 모든 인터넷 라우터가 회사 네트워크로의 경로를 확보할 수 있게됨
   4. 실제 작동 과정 예시
      사용자가 www.xanadu.com 접속 시:
      1. DNS 조회로 IP 주소 확인
      2. 해당 IP로 데이터그램 전송
      3. BGP를 통해 알게 된 경로로 패킷 전달
      4. 최종적으로 회사의 웹 서버에 도달










