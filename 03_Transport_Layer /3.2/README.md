# 3.2 다중화와 역다중화


> 네트워크 계층이 제공하는 호스트 간 전달 서비스를 애플리케이션을 위한 프로세스 간 전달 서비스로 확장하는 것.
모든 컴퓨터 네트워크에서 다중화/역다중화 서비스가 필요하다! <br>
전송 계층은 바로 아래의 네트워크 계층으로부터 세그먼트를 받고, 이를 적절한 애플리케이션 프로세스에 전달할 책임이 있다. 
<br>

#### 컴퓨터 전송 계층이 네트워크로부터 데이터를 받으면, 받은 데이터를 어디로 보내나?

프로세스는 하나 이상의 소켓(데이터가 네트워크와 프로세스간에 통과하는 문)을 가질 수 있었음. 
![image](https://github.com/user-attachments/assets/fbe0eb70-97c5-4c01-b54c-98a298384017)


<그림 3.2>에서 보듯이, **전송 계층은 데이터를 프로세스에 직접 전달하지 않고 중간 소켓으로 전달함** 
(이때 소켓은 고유한 식별자를 가짐.)
#### 이제 수신 호스트가 들어온 전송 계층 세그먼트를 적절한 소켓으로 어떻게 보내는지 살펴보자
각 전송 계층 세그먼트에는 이를 위한 **필드 세트**가 있다. 수신측 전송 계층은 이 필드를 검사하여 소켓을 식별하고 세그먼트를 해당 소켓으로 보낸다. 

이처럼, **전송 계층 세그먼트의 데이터를 올바른 소켓으로 전달하는 작업**을 **역다중화**라고 한다.

#### 다중화: 소스 호스트에서 다른 소켓으로부터 데이터를 수집하고, 각 데이터를 헤더 정보로 캡슐화하여 세그먼트를 만들어 네트워크로 전달하는 작업

다중화는 <br>
1) 소켓이 고유한 식별자를 가져야함
2) 각 세그먼트에 전달될 소켓을 나타내는 특별할 필드가 있어야함<BR>
   그림 3.3에 나타난 이 특별한 필드들은 출발지 포트 번호 필드와 목적지 포트 번호 필드
![image](https://github.com/user-attachments/assets/30ac187a-5fb5-4b71-b675-cb0515e1038a)


> **정리** <br>
호스트이 각 소켓에 포트 번호를 할당하고, 세그먼트가 호스트에 도착하면 전송 계층이 세그먼트의 **목적지 포트 번호**를 검사하여 해당 소켓으로 세그먼트를 보냄. 그러면 세그먼트의 데이터는 소켓을 통해 프로세스로 전달된다! -> **UDP의 기본 작동 방식**. (추후에 TCP랑 또 다룬다) 


### 연결 없는 다중화와 역다중화
> UDP 소켓<BR>
clientSocket = socket(AF_INET, SOCK_DGRAM)<BR>
전송 계층은 자동으로 소켓에 포트 번호 할당(잘사용하지않는1024~65535)<BR>
> clientSocket.bind(('', 19157))<BR>
특정 포트번호 19157에 UDP소켓 연결

![image](https://github.com/user-attachments/assets/6292cc31-fa71-41ca-8045-e45fc18a12dc)
<BR>

### 연결지향형 다중화와 역다중화

TCP 소켓과 UDP 소켓의 미묘한 차이점 중 하나는 TCP 소켓이 4개의 요소로 식별된다는 것(출발지 IP 주소, 출발지 포트 번호, 목적지 IP 주소, 목적지 포트 번호)
-> TCP세그먼트가 네트워크에서 호스트로 도착하면, 호스트는 이 **네가지 값을 모두 사용하여 세그먼트를 적절한 소켓으로 전달(역다중화)**


<2.72절의  TCP 클라이언트-서버 프로그래밍 예제를 다시 살펴봄>
> TCP클라이언트는 소켓을 생성하고 연결 설정 요청 세그먼트를 보냄<br>
> clientSocket = socket(AF_INET, SOCK_STREAM)<br>
clientSocket.connect((serverName,12000))<br>
> 호스트 운영체제가 포트 12000을 가진 연결 요청 세그먼트를 받으면, 서버 프로세스는 새로운 소켓을 생성함.<br>
> connectionSocket, addr = serverSocket.accept()<br>
> 또한, 서버의 전송 계층은 연결 요청 세그먼트에서 4가지 값을 기록한다.<br>
1) 세그먼트의 출발지 포트 번호
2) 출발지 호스트의 IP 주소
3) 세그먼트의 목적지 포트 번호
4) 자신의 IP 주소
   이후 도착하는 모든 세그먼트 중 출발지 포트, 출발지 IP 주소, 목적지 포트, 목적지 IP 주소가 이 네 가지 값과 일치하면 이 소켓으로 역다중화.
   -> TCP 연결이 설정되었으므로, 클라이언트와 서버는 서로 데이터를 주고 받음.

![image](https://github.com/user-attachments/assets/0ff05b2f-75fa-415e-8407-622f14d51aa1)


![image](https://github.com/user-attachments/assets/f439bd7f-7bb9-4a0f-b342-ecf47159eb50)
<BR>
### 웹 서버와 TCP

서버는 출발지 IP 주소와 출발지 포트 번호를 사용하여 서로 다른 클라이언트의 세그먼트를 구분한다.

그림 3.5는 각 연결마다 새로운 프로세스를 생성하는 웹 서버를 보여준다. 각 프로세스는 HTTP 요청이 도착하고 HTTP 응답이 전송되는 자체 연결 소켓을 가지는데, 

연결 소켓과 프로세스 간에 항상 1:1 대응 관계가 있는 것은 아니다. 
> 오늘날의 고성능 웹 서버들은 종종 하나의 프로세스만 사용하고, 새로운 클라이언트 연결마다 새로운 연결 소켓을 가진 새로운 스레드를 생성한다.
<BR>

---

**요약**<BR>
다중화: 소스 호스트에서 여러 소켓의 데이터를 수집하여 세그먼트로 만들어 네트워크 계층으로 보내는 과정<BR>
역다중화: 목적지 호스트에서 네트워크 계층으로부터 받은 세그먼트를 적절한 애플리케이션 프로세스의 소켓으로 전달하는 과정<BR>
소켓: 데이터가 네트워크와 프로세스 사이를 오가는 중간 지점으로, 각각 고유한 식별자를 가짐<BR>
세그먼트: 전송 계층에서 다루는 데이터 단위로, 목적지 소켓을 식별할 수 있는 필드를 포함<BR>
**전송 계층은 바로 아래의 네트워크 계층으로부터 세그먼트를 받고, 이를 적절한 애플리케이션 프로세스에 전달할 책임이 있다.**
