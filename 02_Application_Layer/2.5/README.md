## 2.1.5 P2P 파일 분배

### **P2P 아키텍처 개요**  
섹션 2.1.1에서 설명한 바와 같이, P2P 아키텍처는 항상 켜져 있는 인프라스트럭처 서버에 대한 의존이 최소화(또는 없음)된 구조. 대신, 피어(peer)라고 불리는 간헐적으로 연결된 호스트 쌍이 서로 직접 통신.
피어들은 서비스 제공자에 의해 소유되지 않으며, 사용자가 제어하는 PC, 노트북, 스마트폰으로 구성.

---

### **P2P 아키텍처의 확장성**  

서버와 피어들은 인터넷 접속 링크를 통해 연결.

- **서버의 업로드 속도**: u(s)
- **\( i \)번째 피어의 업로드 속도**: u(i)  
- **\( i \)번째 피어의 다운로드 속도**: d(i)
- **분배할 파일 크기 (비트 단위)**: F
- **파일 복사본을 얻으려는 피어의 수**: N
- **분배 시간**: 모든 N개의 피어가 파일 복사본을 받는 데 걸리는 시간  

---

### **가정**  
1. 인터넷 코어는 충분한 대역폭을 제공하며, 병목 현상은 접속 네트워크에서 발생.  
2. 서버와 클라이언트는 네트워크의 다른 애플리케이션에 참여하지 않으며, 모든 업로드 및 다운로드 대역폭을 파일 분배에 전용.

---

### **클라이언트-서버 아키텍처**

- 피어는 파일 분배에 도움을 주지 않음.
- 클라이언트-서버 아키텍처의 분배 시간: D(cs) 
- 서버는 각 피어에게 파일을 한 번씩 전송해야 하므로 총 ( NF ) 비트를 전송: NF/u(s)
- 다운로드 속도가 가장 느린 피어의 다운로드 속도를 d(min)이라 할때, 최소 분배 시간: F/d(min)

---

### **최종 식**  
- 위 내용을 종합하면, 클라이언트-서버 아키텍처의 최소 분배 시간은 다음과 같음: D(cs) ≧ max{ NF/u(s) , F/d(min)} (식 2.1)
- 이 식은 클라이언트-서버 아키텍처에서의 **최소 분배 시간**(하한선)을 나타냄.
- 피어의 수 ( N )가 충분히 큰 경우, 클라이언트-서버 분배 시간은 NF/u(s)로 증가하며, 피어 수에 비례하여 증가함.
---

### **P2P 아키텍처**

- 각 피어는 서버의 파일 분배를 도움.
- 피어가 파일 데이터를 받으면, 자신의 업로드 대역폭을 사용하여 다른 피어에게 데이터를 재분배 가능.
- **분배 시작 시점**: 서버만 파일을 보유.  
- **모든 비트를 최소 한 번 전송해야 하는 시간**: F/u(s)
- **최소 분배 시간**: F/d(min)

---

### **시스템 전체 업로드 용량**  
시스템 전체 업로드 용량은 **서버의 업로드 속도**와 **개별 피어들의 업로드 속도 총합**으로 이루어짐:  
u(total) = u(s) + u(1) + ... + u(n)

---

### **최종 식**  
위 내용을 종합하면, P2P 아키텍처의 최소 분배 시간 D(p2p)는 다음과 같음: D(p2p) ≧ max {F/u(s) , F/d(min), NF/u(total)} (식 2.2)

---

### **재분배 방식**  
- 각 피어가 비트를 받자마자 재분배할 수 있다면, 이 하한선을 실제로 달성할 수 있는 재분배 방식이 존재.  
- 그러나 실제로는 개별 비트가 아니라 **파일의 조각**을 재분배하기 때문에, 식 (2.2)는 **실제 최소 분배 시간에 대한 근사치**로 사용됨.

---

### **그림 2.23: 클라이언트-서버와 P2P 아키텍처의 비교**  

![image](https://github.com/user-attachments/assets/e2c327c7-b0e8-4c5d-bcb0-a8b4242307bb)


**클라이언트-서버 아키텍처**:  
- 피어 수가 증가함에 따라 분배 시간이 선형적으로 증가하며 제한이 없음.  

**P2P 아키텍처**:  
- 최소 분배 시간은 클라이언트-서버 아키텍처보다 항상 짧으며, 피어 수에 관계없이 1시간 이내에 분배가 가능.  

P2P 아키텍처를 사용하는 애플리케이션은 **셀프 스케일링(self-scaling)** 이 가능함. 이는 **피어가 비트의 소비자일 뿐만 아니라 재분배자 역할**을 하기 때문.

---

### **BitTorrent**
P2P 파일 분배 프로토콜 중 하나.

![image](https://github.com/user-attachments/assets/25ef7483-f087-4803-b2d4-08a69a56098a)

### **비트토렌트(BitTorrent) 파일 분배 프로토콜**

1. **토렌트(Torrent)의 정의**  
   - 비트토렌트 용어에서, 특정 파일의 분배에 참여하는 모든 피어들의 모임을 **토렌트**라고 부름.

2. **파일 조각(Chunks)**  
   - 피어들은 파일을 동일한 크기의 조각으로 나누어 다운로드.  
   - 일반적인 조각 크기는 **256 KB**.

3. **피어의 동작**  
   - **토렌트에 처음 참여한 피어**는 다운로드할 조각이 없음.  
   - 시간이 지나면서 피어는 더 많은 조각을 다운로드하여 수집.  

4. **업로드 및 다운로드**  
   - 피어가 조각을 다운로드하면서, 동시에 다른 피어들에게 조각을 업로드.

5. **파일 다운로드 완료 후 피어의 선택**  
   - 피어가 전체 파일을 다운로드한 후, 두 가지 행동을 할 수 있음:
     1. **이기적 행동**: 토렌트를 떠나 더 이상 다른 피어에게 조각을 업로드하지 않음.  
     2. **이타적 행동**: 토렌트에 남아 다른 피어들에게 조각을 업로드함.

6. **토렌트 참여 및 재참여**  
   - 피어는 언제든지 일부 조각만 가지고 토렌트를 떠날 수 있음.  
   - 이후 다시 토렌트에 재참여하여 남은 조각을 다운로드 가능.

---

### **트래커**
- 각 토렌트에는 트래커라고 불리는 인프라스트럭쳐 노드가 존재.
- 이는 한 피어가 토렌트에 가입할 때, 트래커에 자신을 등록하고 주기적으로 자신이 아직 토렌트에 있음을 알림으로써 트래커는 토렌트에 있는 피어들을 추적할 수 있음.

---

### **희귀한 것 우선**
- 정보를 받을때, 무엇을 먼저 요구할지 / 이웃들 중 어떤 피어에게 요청할지를 결정해야 함.
- 이때 결정방식으로 **rarest first**를 사용: 이웃 가운데 가장 드문 청크를 결정하고 이를 먼저 요구하는 방식
- 이를 사용하는 이유: 가장 드문 청크들이 더 빨리 재분배될 수 있어서 각 청크의 복사본 수가 대략적으로 동일해질 수 있음.

---

### **비트토렌트의 트레이딩 알고리즘**
- 가장 기본적인 아이디어: 가장 높은 전송 속도로 데이터를 공급하는 이웃 피어에게 우선순위를 부여하는 것
  1. **최고 전송 속도의 피어를 선택**: 각 이웃 피어가 보내는 데이터 전송 속도를 측정, 가장 높은 전송 속도를 제공하는 4명의 피어를 선택
  2. **주기적인 갱신**: 10초마다 재계산하여 4명의 피어목록 갱신
  3. **무작위로 선택, 파일 조각을 전송**: 30초마다 무작위로 한 이웃 피어를 선택, 파일 조각을 전송
     - 이 무작위로 선택된 피어와 같은 경우 **optimistically unchoked** 피어라고 부름.
     - 데이터를 전송한 피어는 데이터를 받은 피어의 상위 4명 피어 목록에 추가할 가능성이 생김.
     - 만약 데이터를 받은 피어가 데이터를 전송한 피어에게 높은 속도로 데이터를 보낼 경우, 이는 전송한 피어의 상위 4명 업로더가 될 수 있음.
  4. **트레이딩 관계와 동작**:
     - 30초마다 새로운 트레이딩 파트너를 선택하여 트레이딩을 시작
     - 두 피어가 트레이딩에 만족 시 서로의 상위 4명 목록에 유지
     - 더 좋은 파트너를 찾을 시 기존 파트너를 대체
     - 이 방식으로 비슷한 업로드 속도를 가진 피어들이 서로를 발견하여 트레이딩
- 랜덤한 이웃 선택은 새로운 피어가 파일 조각을 다운로드하여 트레이딩할 데이터를 확보할 기회를 제공
- **Choked**: 상위 4명의 피어 + 무작위로 선정된 1명을 제외한 모든 이웃 피어
  - Choked 피어와 같은 경우 파일 조각을 받을 수 없음.

---

### **tit-for-tat mechanism**
- 인센티브 메커니즘으로 서로 데이터를 주고받는 트레이딩을 기반으로 하며, 일부 피어가 이 전략을 우회할 수 있다는 연구 결과도 있음.
- 그러나 이 메커니즘이 없었다면, 비트토렌트는 대부분의 유저가 프리라이더가 되었을 것이기에 현재가지 남아있지 못했을 것.
